// Generated by ./scripts/test.py:
//
// ./scripts/test.py -c tests/test_move.toml -o tests/test_move.t.a.c
//

#include "runners/test_runner.h"

#ifndef ERASE_CYCLES
#define ERASE_CYCLES_i           TEST_IMPLICIT_DEFINE_COUNT+0
#define ERASE_CYCLES             TEST_DEFINE(ERASE_CYCLES_i)
#endif
#ifndef RELOCATIONS
#define RELOCATIONS_i            TEST_IMPLICIT_DEFINE_COUNT+1
#define RELOCATIONS              TEST_DEFINE(RELOCATIONS_i)
#endif

void __test__test_move_file__run(__attribute__((unused)) struct lfs_config *cfg) {
    // test case test_move_file
    #line 3 "tests/test_move.toml"
    lfs_t lfs;
    lfs_format(&lfs, cfg) => 0;
    lfs_mount(&lfs, cfg) => 0;
    lfs_mkdir(&lfs, "a") => 0;
    lfs_mkdir(&lfs, "b") => 0;
    lfs_mkdir(&lfs, "c") => 0;
    lfs_mkdir(&lfs, "d") => 0;
    lfs_file_t file;
    lfs_file_open(&lfs, &file, "a/hello", LFS_O_CREAT | LFS_O_WRONLY) => 0;
    lfs_file_write(&lfs, &file, "hola\n", 5) => 5;
    lfs_file_write(&lfs, &file, "bonjour\n", 8) => 8;
    lfs_file_write(&lfs, &file, "ohayo\n", 6) => 6;
    lfs_file_close(&lfs, &file) => 0;
    lfs_unmount(&lfs) => 0;

    lfs_mount(&lfs, cfg) => 0;
    lfs_rename(&lfs, "a/hello", "c/hello") => 0;
    lfs_unmount(&lfs) => 0;

    lfs_mount(&lfs, cfg) => 0;
    lfs_dir_t dir;
    struct lfs_info info;
    lfs_dir_open(&lfs, &dir, "a") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;
    lfs_dir_open(&lfs, &dir, "c") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "hello") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 5+8+6);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_file_open(&lfs, &file, "a/hello", LFS_O_RDONLY) => LFS_ERR_NOENT;
    lfs_file_open(&lfs, &file, "b/hello", LFS_O_RDONLY) => LFS_ERR_NOENT;
    lfs_file_open(&lfs, &file, "c/hello", LFS_O_RDONLY) => 0;
    uint8_t buffer[1024];
    lfs_file_read(&lfs, &file, buffer, 5) => 5;
    memcmp(buffer, "hola\n", 5) => 0;
    lfs_file_read(&lfs, &file, buffer, 8) => 8;
    memcmp(buffer, "bonjour\n", 8) => 0;
    lfs_file_read(&lfs, &file, buffer, 6) => 6;
    memcmp(buffer, "ohayo\n", 6) => 0;
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "d/hello", LFS_O_RDONLY) => LFS_ERR_NOENT;
    lfs_unmount(&lfs) => 0;
    #line 79 "tests/test_move.t.a.c"
}

void __test__test_move_nop__run(__attribute__((unused)) struct lfs_config *cfg) {
    // test case test_move_nop
    #line 65 "tests/test_move.toml"
    lfs_t lfs;
    lfs_format(&lfs, cfg) => 0;
    lfs_mount(&lfs, cfg) => 0;
    lfs_mkdir(&lfs, "hi") => 0;
    lfs_rename(&lfs, "hi", "hi") => 0;
    lfs_mkdir(&lfs, "hi/hi") => 0;
    lfs_rename(&lfs, "hi/hi", "hi/hi") => 0;
    lfs_mkdir(&lfs, "hi/hi/hi") => 0;
    lfs_rename(&lfs, "hi/hi/hi", "hi/hi/hi") => 0;
    struct lfs_info info;
    lfs_stat(&lfs, "hi/hi/hi", &info) => 0;
    assert(strcmp(info.name, "hi") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_unmount(&lfs) => 0;
    #line 99 "tests/test_move.t.a.c"
}

extern void __test__test_move_file_corrupt_source__run(struct lfs_config *cfg);

extern bool __test__test_move_file_corrupt_source_dest__filter(void);
extern void __test__test_move_file_corrupt_source_dest__run(struct lfs_config *cfg);

extern bool __test__test_move_file_after_corrupt__filter(void);
extern void __test__test_move_file_after_corrupt__run(struct lfs_config *cfg);

void __test__test_move_reentrant_file__run(__attribute__((unused)) struct lfs_config *cfg) {
    // test case test_move_reentrant_file
    #line 361 "tests/test_move.toml"
    lfs_t lfs;
    int err = lfs_mount(&lfs, cfg);
    if (err) {
        lfs_format(&lfs, cfg) => 0;
        lfs_mount(&lfs, cfg) => 0;
    }
    err = lfs_mkdir(&lfs, "a");
    assert(!err || err == LFS_ERR_EXIST);
    err = lfs_mkdir(&lfs, "b");
    assert(!err || err == LFS_ERR_EXIST);
    err = lfs_mkdir(&lfs, "c");
    assert(!err || err == LFS_ERR_EXIST);
    err = lfs_mkdir(&lfs, "d");
    assert(!err || err == LFS_ERR_EXIST);
    lfs_unmount(&lfs) => 0;

    while (true) {
        lfs_mount(&lfs, cfg) => 0;
        // there should never exist _2_ hello files
        int count = 0;
        struct lfs_info info;
        if (lfs_stat(&lfs, "a/hello", &info) == 0) {
            assert(strcmp(info.name, "hello") == 0);
            assert(info.type == LFS_TYPE_REG);
            assert(info.size == 5+8+6 || info.size == 0);
            count += 1;
        }
        if (lfs_stat(&lfs, "b/hello", &info) == 0) {
            assert(strcmp(info.name, "hello") == 0);
            assert(info.type == LFS_TYPE_REG);
            assert(info.size == 5+8+6);
            count += 1;
        }
        if (lfs_stat(&lfs, "c/hello", &info) == 0) {
            assert(strcmp(info.name, "hello") == 0);
            assert(info.type == LFS_TYPE_REG);
            assert(info.size == 5+8+6);
            count += 1;
        }
        if (lfs_stat(&lfs, "d/hello", &info) == 0) {
            assert(strcmp(info.name, "hello") == 0);
            assert(info.type == LFS_TYPE_REG);
            assert(info.size == 5+8+6);
            count += 1;
        }
        assert(count <= 1);
        lfs_unmount(&lfs) => 0;

        lfs_mount(&lfs, cfg) => 0;
        if (lfs_stat(&lfs, "a/hello", &info) == 0 && info.size > 0) {
            lfs_rename(&lfs, "a/hello", "b/hello") => 0;
        } else if (lfs_stat(&lfs, "b/hello", &info) == 0) {
            lfs_rename(&lfs, "b/hello", "c/hello") => 0;
        } else if (lfs_stat(&lfs, "c/hello", &info) == 0) {
            lfs_rename(&lfs, "c/hello", "d/hello") => 0;
        } else if (lfs_stat(&lfs, "d/hello", &info) == 0) {
            // success
            lfs_unmount(&lfs) => 0;
            break;
        } else {
            // create file
            lfs_file_t file;
            lfs_file_open(&lfs, &file, "a/hello",
                    LFS_O_WRONLY | LFS_O_CREAT) => 0;
            lfs_file_write(&lfs, &file, "hola\n", 5) => 5;
            lfs_file_write(&lfs, &file, "bonjour\n", 8) => 8;
            lfs_file_write(&lfs, &file, "ohayo\n", 6) => 6;
            lfs_file_close(&lfs, &file) => 0;
        }
        lfs_unmount(&lfs) => 0;
    }

    lfs_mount(&lfs, cfg) => 0;
    lfs_dir_t dir;
    struct lfs_info info;
    lfs_dir_open(&lfs, &dir, "a") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;
    lfs_dir_open(&lfs, &dir, "d") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "hello") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 5+8+6);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_file_t file;
    lfs_file_open(&lfs, &file, "a/hello", LFS_O_RDONLY) => LFS_ERR_NOENT;
    lfs_file_open(&lfs, &file, "b/hello", LFS_O_RDONLY) => LFS_ERR_NOENT;
    lfs_file_open(&lfs, &file, "c/hello", LFS_O_RDONLY) => LFS_ERR_NOENT;
    lfs_file_open(&lfs, &file, "d/hello", LFS_O_RDONLY) => 0;
    uint8_t buffer[1024];
    lfs_file_read(&lfs, &file, buffer, 5) => 5;
    memcmp(buffer, "hola\n", 5) => 0;
    lfs_file_read(&lfs, &file, buffer, 8) => 8;
    memcmp(buffer, "bonjour\n", 8) => 0;
    lfs_file_read(&lfs, &file, buffer, 6) => 6;
    memcmp(buffer, "ohayo\n", 6) => 0;
    lfs_file_close(&lfs, &file) => 0;
    lfs_unmount(&lfs) => 0;
    #line 225 "tests/test_move.t.a.c"
}

void __test__test_move_dir__run(__attribute__((unused)) struct lfs_config *cfg) {
    // test case test_move_dir
    #line 477 "tests/test_move.toml"
    lfs_t lfs;
    lfs_format(&lfs, cfg) => 0;
    lfs_mount(&lfs, cfg) => 0;
    lfs_mkdir(&lfs, "a") => 0;
    lfs_mkdir(&lfs, "b") => 0;
    lfs_mkdir(&lfs, "c") => 0;
    lfs_mkdir(&lfs, "d") => 0;
    lfs_mkdir(&lfs, "a/hi") => 0;
    lfs_mkdir(&lfs, "a/hi/hola") => 0;
    lfs_mkdir(&lfs, "a/hi/bonjour") => 0;
    lfs_mkdir(&lfs, "a/hi/ohayo") => 0;
    lfs_unmount(&lfs) => 0;

    lfs_mount(&lfs, cfg) => 0;
    lfs_rename(&lfs, "a/hi", "c/hi") => 0;
    lfs_unmount(&lfs) => 0;

    lfs_mount(&lfs, cfg) => 0;
    lfs_dir_t dir;
    struct lfs_info info;
    lfs_dir_open(&lfs, &dir, "a") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;
    lfs_dir_open(&lfs, &dir, "c") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "hi") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_dir_open(&lfs, &dir, "a/hi") => LFS_ERR_NOENT;
    lfs_dir_open(&lfs, &dir, "b/hi") => LFS_ERR_NOENT;
    lfs_dir_open(&lfs, &dir, "c/hi") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "bonjour") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "hola") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "ohayo") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;
    lfs_dir_open(&lfs, &dir, "d/hi") => LFS_ERR_NOENT;
    lfs_unmount(&lfs) => 0;
    #line 295 "tests/test_move.t.a.c"
}

extern void __test__test_move_dir_corrupt_source__run(struct lfs_config *cfg);

extern bool __test__test_move_dir_corrupt_source_dest__filter(void);
extern void __test__test_move_dir_corrupt_source_dest__run(struct lfs_config *cfg);

extern bool __test__test_move_dir_after_corrupt__filter(void);
extern void __test__test_move_dir_after_corrupt__run(struct lfs_config *cfg);

void __test__test_reentrant_dir__run(__attribute__((unused)) struct lfs_config *cfg) {
    // test case test_reentrant_dir
    #line 843 "tests/test_move.toml"
    lfs_t lfs;
    int err = lfs_mount(&lfs, cfg);
    if (err) {
        lfs_format(&lfs, cfg) => 0;
        lfs_mount(&lfs, cfg) => 0;
    }
    err = lfs_mkdir(&lfs, "a");
    assert(!err || err == LFS_ERR_EXIST);
    err = lfs_mkdir(&lfs, "b");
    assert(!err || err == LFS_ERR_EXIST);
    err = lfs_mkdir(&lfs, "c");
    assert(!err || err == LFS_ERR_EXIST);
    err = lfs_mkdir(&lfs, "d");
    assert(!err || err == LFS_ERR_EXIST);
    lfs_unmount(&lfs) => 0;

    while (true) {
        lfs_mount(&lfs, cfg) => 0;
        // there should never exist _2_ hi directories
        int count = 0;
        struct lfs_info info;
        if (lfs_stat(&lfs, "a/hi", &info) == 0) {
            assert(strcmp(info.name, "hi") == 0);
            assert(info.type == LFS_TYPE_DIR);
            count += 1;
        }
        if (lfs_stat(&lfs, "b/hi", &info) == 0) {
            assert(strcmp(info.name, "hi") == 0);
            assert(info.type == LFS_TYPE_DIR);
            count += 1;
        }
        if (lfs_stat(&lfs, "c/hi", &info) == 0) {
            assert(strcmp(info.name, "hi") == 0);
            assert(info.type == LFS_TYPE_DIR);
            count += 1;
        }
        if (lfs_stat(&lfs, "d/hi", &info) == 0) {
            assert(strcmp(info.name, "hi") == 0);
            assert(info.type == LFS_TYPE_DIR);
            count += 1;
        }
        assert(count <= 1);
        lfs_unmount(&lfs) => 0;

        lfs_mount(&lfs, cfg) => 0;
        if (lfs_stat(&lfs, "a/hi", &info) == 0) {
            lfs_rename(&lfs, "a/hi", "b/hi") => 0;
        } else if (lfs_stat(&lfs, "b/hi", &info) == 0) {
            lfs_rename(&lfs, "b/hi", "c/hi") => 0;
        } else if (lfs_stat(&lfs, "c/hi", &info) == 0) {
            lfs_rename(&lfs, "c/hi", "d/hi") => 0;
        } else if (lfs_stat(&lfs, "d/hi", &info) == 0) {
            lfs_unmount(&lfs) => 0;
            break; // success
        } else {
            // create dir and rename for atomicity
            err = lfs_mkdir(&lfs, "temp");
            assert(!err || err == LFS_ERR_EXIST);
            err = lfs_mkdir(&lfs, "temp/hola");
            assert(!err || err == LFS_ERR_EXIST);
            err = lfs_mkdir(&lfs, "temp/bonjour");
            assert(!err || err == LFS_ERR_EXIST);
            err = lfs_mkdir(&lfs, "temp/ohayo");
            assert(!err || err == LFS_ERR_EXIST);
            lfs_rename(&lfs, "temp", "a/hi") => 0;
        }
        lfs_unmount(&lfs) => 0;
    }

    lfs_mount(&lfs, cfg) => 0;
    lfs_dir_t dir;
    struct lfs_info info;
    lfs_dir_open(&lfs, &dir, "a") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;
    lfs_dir_open(&lfs, &dir, "d") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "hi") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_dir_open(&lfs, &dir, "a/hi") => LFS_ERR_NOENT;
    lfs_dir_open(&lfs, &dir, "b/hi") => LFS_ERR_NOENT;
    lfs_dir_open(&lfs, &dir, "c/hi") => LFS_ERR_NOENT;
    lfs_dir_open(&lfs, &dir, "d/hi") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "bonjour") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "hola") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "ohayo") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;
    lfs_unmount(&lfs) => 0;
    #line 425 "tests/test_move.t.a.c"
}

void __test__test_move_state_stealing__run(__attribute__((unused)) struct lfs_config *cfg) {
    // test case test_move_state_stealing
    #line 963 "tests/test_move.toml"
    lfs_t lfs;
    lfs_format(&lfs, cfg) => 0;
    lfs_mount(&lfs, cfg) => 0;
    lfs_mkdir(&lfs, "a") => 0;
    lfs_mkdir(&lfs, "b") => 0;
    lfs_mkdir(&lfs, "c") => 0;
    lfs_mkdir(&lfs, "d") => 0;
    lfs_file_t file;
    lfs_file_open(&lfs, &file, "a/hello", LFS_O_CREAT | LFS_O_WRONLY) => 0;
    lfs_file_write(&lfs, &file, "hola\n", 5) => 5;
    lfs_file_write(&lfs, &file, "bonjour\n", 8) => 8;
    lfs_file_write(&lfs, &file, "ohayo\n", 6) => 6;
    lfs_file_close(&lfs, &file) => 0;
    lfs_unmount(&lfs) => 0;

    lfs_mount(&lfs, cfg) => 0;
    lfs_rename(&lfs, "a/hello", "b/hello") => 0;
    lfs_unmount(&lfs) => 0;
    lfs_mount(&lfs, cfg) => 0;
    lfs_rename(&lfs, "b/hello", "c/hello") => 0;
    lfs_unmount(&lfs) => 0;
    lfs_mount(&lfs, cfg) => 0;
    lfs_rename(&lfs, "c/hello", "d/hello") => 0;
    lfs_unmount(&lfs) => 0;

    lfs_mount(&lfs, cfg) => 0;
    lfs_file_open(&lfs, &file, "a/hello", LFS_O_RDONLY) => LFS_ERR_NOENT;
    lfs_file_open(&lfs, &file, "b/hello", LFS_O_RDONLY) => LFS_ERR_NOENT;
    lfs_file_open(&lfs, &file, "c/hello", LFS_O_RDONLY) => LFS_ERR_NOENT;
    lfs_file_open(&lfs, &file, "d/hello", LFS_O_RDONLY) => 0;
    uint8_t buffer[1024];
    lfs_file_read(&lfs, &file, buffer, 5) => 5;
    memcmp(buffer, "hola\n", 5) => 0;
    lfs_file_read(&lfs, &file, buffer, 8) => 8;
    memcmp(buffer, "bonjour\n", 8) => 0;
    lfs_file_read(&lfs, &file, buffer, 6) => 6;
    memcmp(buffer, "ohayo\n", 6) => 0;
    lfs_file_close(&lfs, &file) => 0;
    lfs_unmount(&lfs) => 0;

    lfs_mount(&lfs, cfg) => 0;
    lfs_remove(&lfs, "b") => 0;
    lfs_remove(&lfs, "c") => 0;
    lfs_unmount(&lfs) => 0;

    lfs_mount(&lfs, cfg) => 0;
    struct lfs_info info;
    lfs_stat(&lfs, "a", &info) => 0;
    lfs_stat(&lfs, "b", &info) => LFS_ERR_NOENT;
    lfs_stat(&lfs, "c", &info) => LFS_ERR_NOENT;
    lfs_stat(&lfs, "d", &info) => 0;
    lfs_file_open(&lfs, &file, "a/hello", LFS_O_RDONLY) => LFS_ERR_NOENT;
    lfs_file_open(&lfs, &file, "b/hello", LFS_O_RDONLY) => LFS_ERR_NOENT;
    lfs_file_open(&lfs, &file, "c/hello", LFS_O_RDONLY) => LFS_ERR_NOENT;
    lfs_file_open(&lfs, &file, "d/hello", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 5) => 5;
    memcmp(buffer, "hola\n", 5) => 0;
    lfs_file_read(&lfs, &file, buffer, 8) => 8;
    memcmp(buffer, "bonjour\n", 8) => 0;
    lfs_file_read(&lfs, &file, buffer, 6) => 6;
    memcmp(buffer, "ohayo\n", 6) => 0;
    lfs_file_close(&lfs, &file) => 0;
    lfs_unmount(&lfs) => 0;
    #line 494 "tests/test_move.t.a.c"
}

void __test__test_move_create_delete_same__run(__attribute__((unused)) struct lfs_config *cfg) {
    // test case test_move_create_delete_same
    #line 1033 "tests/test_move.toml"
    lfs_t lfs;
    lfs_format(&lfs, cfg) => 0;
    lfs_mount(&lfs, cfg) => 0;

    // littlefs keeps files sorted, so we know the order these will be in
    lfs_file_t file;
    lfs_file_open(&lfs, &file, "/1.move_me",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_open(&lfs, &file, "/0.before",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "test.1", 7) => 7;
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_open(&lfs, &file, "/2.in_between",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "test.2", 7) => 7;
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_open(&lfs, &file, "/4.after",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "test.3", 7) => 7;
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_t files[3];
    lfs_file_open(&lfs, &files[0], "0.before",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[1], "2.in_between",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[2], "4.after",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_write(&lfs, &files[0], "test.4", 7) => 7;
    lfs_file_write(&lfs, &files[1], "test.5", 7) => 7;
    lfs_file_write(&lfs, &files[2], "test.6", 7) => 7;

    // rename file while everything is open, this triggers both
    // a create and delete simultaneously
    lfs_rename(&lfs, "/1.move_me", "/3.move_me") => 0;

    lfs_file_close(&lfs, &files[0]) => 0;
    lfs_file_close(&lfs, &files[1]) => 0;
    lfs_file_close(&lfs, &files[2]) => 0;

    // check that nothing was corrupted
    lfs_dir_t dir;
    struct lfs_info info;
    lfs_dir_open(&lfs, &dir, "/") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "0.before") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "2.in_between") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "3.move_me") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 0);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "4.after") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_file_open(&lfs, &file, "/0.before", LFS_O_RDONLY) => 0;
    uint8_t buffer[1024];
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.4") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/2.in_between", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.5") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/4.after", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.6") == 0);
    lfs_file_close(&lfs, &file) => 0;

    // now move back
    lfs_file_open(&lfs, &files[0], "0.before",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[1], "2.in_between",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[2], "4.after",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_write(&lfs, &files[0], "test.7", 7) => 7;
    lfs_file_write(&lfs, &files[1], "test.8", 7) => 7;
    lfs_file_write(&lfs, &files[2], "test.9", 7) => 7;

    // rename file while everything is open, this triggers both
    // a create and delete simultaneously
    lfs_rename(&lfs, "/3.move_me", "/1.move_me") => 0;

    lfs_file_close(&lfs, &files[0]) => 0;
    lfs_file_close(&lfs, &files[1]) => 0;
    lfs_file_close(&lfs, &files[2]) => 0;

    // and check that nothing was corrupted again
    lfs_dir_open(&lfs, &dir, "/") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "0.before") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "1.move_me") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 0);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "2.in_between") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "4.after") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_file_open(&lfs, &file, "/0.before", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.7") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/2.in_between", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.8") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/4.after", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.9") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_unmount(&lfs) => 0;
    #line 646 "tests/test_move.t.a.c"
}

void __test__test_move_create_delete_delete_same__run(__attribute__((unused)) struct lfs_config *cfg) {
    // test case test_move_create_delete_delete_same
    #line 1184 "tests/test_move.toml"
    lfs_t lfs;
    lfs_format(&lfs, cfg) => 0;
    lfs_mount(&lfs, cfg) => 0;

    // littlefs keeps files sorted, so we know the order these will be in
    lfs_file_t file;
    lfs_file_open(&lfs, &file, "/1.move_me",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/3.move_me",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "remove me",
            sizeof("remove me")) => sizeof("remove me");
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_open(&lfs, &file, "/0.before",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "test.1", 7) => 7;
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_open(&lfs, &file, "/2.in_between",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "test.2", 7) => 7;
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_open(&lfs, &file, "/4.after",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "test.3", 7) => 7;
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_t files[3];
    lfs_file_open(&lfs, &files[0], "0.before",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[1], "2.in_between",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[2], "4.after",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_write(&lfs, &files[0], "test.4", 7) => 7;
    lfs_file_write(&lfs, &files[1], "test.5", 7) => 7;
    lfs_file_write(&lfs, &files[2], "test.6", 7) => 7;

    // rename file while everything is open, this triggers both
    // a create and delete simultaneously
    lfs_rename(&lfs, "/1.move_me", "/3.move_me") => 0;

    lfs_file_close(&lfs, &files[0]) => 0;
    lfs_file_close(&lfs, &files[1]) => 0;
    lfs_file_close(&lfs, &files[2]) => 0;

    // check that nothing was corrupted
    lfs_dir_t dir;
    struct lfs_info info;
    lfs_dir_open(&lfs, &dir, "/") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "0.before") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "2.in_between") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "3.move_me") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 0);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "4.after") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_file_open(&lfs, &file, "/0.before", LFS_O_RDONLY) => 0;
    uint8_t buffer[1024];
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.4") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/2.in_between", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.5") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/4.after", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.6") == 0);
    lfs_file_close(&lfs, &file) => 0;

    // now move back
    lfs_file_open(&lfs, &file, "/1.move_me",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "remove me",
            sizeof("remove me")) => sizeof("remove me");
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_open(&lfs, &files[0], "0.before",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[1], "2.in_between",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[2], "4.after",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_write(&lfs, &files[0], "test.7", 7) => 7;
    lfs_file_write(&lfs, &files[1], "test.8", 7) => 7;
    lfs_file_write(&lfs, &files[2], "test.9", 7) => 7;

    // rename file while everything is open, this triggers both
    // a create and delete simultaneously
    lfs_rename(&lfs, "/3.move_me", "/1.move_me") => 0;

    lfs_file_close(&lfs, &files[0]) => 0;
    lfs_file_close(&lfs, &files[1]) => 0;
    lfs_file_close(&lfs, &files[2]) => 0;

    // and check that nothing was corrupted again
    lfs_dir_open(&lfs, &dir, "/") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "0.before") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "1.move_me") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 0);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "2.in_between") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "4.after") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_file_open(&lfs, &file, "/0.before", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.7") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/2.in_between", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.8") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/4.after", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.9") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_unmount(&lfs) => 0;
    #line 809 "tests/test_move.t.a.c"
}

void __test__test_move_create_delete_different__run(__attribute__((unused)) struct lfs_config *cfg) {
    // test case test_move_create_delete_different
    #line 1346 "tests/test_move.toml"
    lfs_t lfs;
    lfs_format(&lfs, cfg) => 0;
    lfs_mount(&lfs, cfg) => 0;

    // littlefs keeps files sorted, so we know the order these will be in
    lfs_mkdir(&lfs, "/dir.1") => 0;
    lfs_mkdir(&lfs, "/dir.2") => 0;
    lfs_file_t file;
    lfs_file_open(&lfs, &file, "/dir.1/1.move_me",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/dir.2/1.move_me",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "remove me",
            sizeof("remove me")) => sizeof("remove me");
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_open(&lfs, &file, "/dir.1/0.before",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "test.1", 7) => 7;
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/dir.1/2.after",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "test.2", 7) => 7;
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_open(&lfs, &file, "/dir.2/0.before",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "test.3", 7) => 7;
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/dir.2/2.after",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "test.4", 7) => 7;
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_t files[4];
    lfs_file_open(&lfs, &files[0], "/dir.1/0.before",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[1], "/dir.1/2.after",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[2], "/dir.2/0.before",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[3], "/dir.2/2.after",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_write(&lfs, &files[0], "test.5", 7) => 7;
    lfs_file_write(&lfs, &files[1], "test.6", 7) => 7;
    lfs_file_write(&lfs, &files[2], "test.7", 7) => 7;
    lfs_file_write(&lfs, &files[3], "test.8", 7) => 7;

    // rename file while everything is open, this triggers both
    // a create and delete as it overwrites the destination file
    lfs_rename(&lfs, "/dir.1/1.move_me", "/dir.2/1.move_me") => 0;

    lfs_file_close(&lfs, &files[0]) => 0;
    lfs_file_close(&lfs, &files[1]) => 0;
    lfs_file_close(&lfs, &files[2]) => 0;
    lfs_file_close(&lfs, &files[3]) => 0;

    // check that nothing was corrupted
    lfs_dir_t dir;
    struct lfs_info info;
    lfs_dir_open(&lfs, &dir, "/") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "dir.1") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "dir.2") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_dir_open(&lfs, &dir, "/dir.1") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "0.before") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "2.after") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_dir_open(&lfs, &dir, "/dir.2") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "0.before") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "1.move_me") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 0);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "2.after") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_file_open(&lfs, &file, "/dir.1/0.before", LFS_O_RDONLY) => 0;
    uint8_t buffer[1024];
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.5") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/dir.1/2.after", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.6") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/dir.2/0.before", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.7") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/dir.2/2.after", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.8") == 0);
    lfs_file_close(&lfs, &file) => 0;

    // now move back
    lfs_file_open(&lfs, &file, "/dir.1/1.move_me",
            LFS_O_WRONLY | LFS_O_CREAT) => 0;
    lfs_file_write(&lfs, &file, "remove me",
            sizeof("remove me")) => sizeof("remove me");
    lfs_file_close(&lfs, &file) => 0;

    lfs_file_open(&lfs, &files[0], "/dir.1/0.before",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[1], "/dir.1/2.after",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[2], "/dir.2/0.before",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_open(&lfs, &files[3], "/dir.2/2.after",
            LFS_O_WRONLY | LFS_O_TRUNC) => 0;
    lfs_file_write(&lfs, &files[0], "test.9", 7) => 7;
    lfs_file_write(&lfs, &files[1], "test.a", 7) => 7;
    lfs_file_write(&lfs, &files[2], "test.b", 7) => 7;
    lfs_file_write(&lfs, &files[3], "test.c", 7) => 7;

    // rename file while everything is open, this triggers both
    // a create and delete simultaneously
    lfs_rename(&lfs, "/dir.2/1.move_me", "/dir.1/1.move_me") => 0;

    lfs_file_close(&lfs, &files[0]) => 0;
    lfs_file_close(&lfs, &files[1]) => 0;
    lfs_file_close(&lfs, &files[2]) => 0;
    lfs_file_close(&lfs, &files[3]) => 0;

    // and check that nothing was corrupted again
    lfs_dir_open(&lfs, &dir, "/") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "dir.1") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "dir.2") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_dir_open(&lfs, &dir, "/dir.1") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "0.before") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "1.move_me") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 0);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "2.after") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_dir_open(&lfs, &dir, "/dir.2") => 0;
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, ".") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "..") == 0);
    assert(info.type == LFS_TYPE_DIR);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "0.before") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 1;
    assert(strcmp(info.name, "2.after") == 0);
    assert(info.type == LFS_TYPE_REG);
    assert(info.size == 7);
    lfs_dir_read(&lfs, &dir, &info) => 0;
    lfs_dir_close(&lfs, &dir) => 0;

    lfs_file_open(&lfs, &file, "/dir.1/0.before", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.9") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/dir.1/2.after", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.a") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/dir.2/0.before", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.b") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_file_open(&lfs, &file, "/dir.2/2.after", LFS_O_RDONLY) => 0;
    lfs_file_read(&lfs, &file, buffer, 7) => 7;
    assert(strcmp((char*)buffer, "test.c") == 0);
    lfs_file_close(&lfs, &file) => 0;
    lfs_unmount(&lfs) => 0;
    #line 1053 "tests/test_move.t.a.c"
}

extern const test_define_t __test__test_move_fix_relocation__defines[][TEST_IMPLICIT_DEFINE_COUNT+2];
extern void __test__test_move_fix_relocation__run(struct lfs_config *cfg);

extern const test_define_t __test__test_move_fix_relocation_predecessor__defines[][TEST_IMPLICIT_DEFINE_COUNT+2];
extern void __test__test_move_fix_relocation_predecessor__run(struct lfs_config *cfg);

__attribute__((section("_test_suites"), aligned(1)))
const struct test_suite __test__test_move__suite = {
    .name = "test_move",
    .path = "tests/test_move.toml",
    .flags = TEST_REENTRANT,
    .define_names = (const char *const[TEST_IMPLICIT_DEFINE_COUNT+2]){
        [ERASE_CYCLES_i          ] = "ERASE_CYCLES",
        [RELOCATIONS_i           ] = "RELOCATIONS",
    },
    .define_count = TEST_IMPLICIT_DEFINE_COUNT+2,
    .cases = (const struct test_case[]){
        {
            .name = "test_move_file",
            .path = "tests/test_move.toml:1",
            .flags = 0,
            .permutations = 1,
            .run = __test__test_move_file__run,
        },
        {
            .name = "test_move_nop",
            .path = "tests/test_move.toml:63",
            .flags = 0,
            .permutations = 1,
            .run = __test__test_move_nop__run,
        },
        {
            .name = "test_move_file_corrupt_source",
            .path = "tests/test_move.toml:81",
            .flags = 0,
            .permutations = 1,
            .run = __test__test_move_file_corrupt_source__run,
        },
        {
            .name = "test_move_file_corrupt_source_dest",
            .path = "tests/test_move.toml:161",
            .flags = 0,
            .permutations = 1,
            .filter = __test__test_move_file_corrupt_source_dest__filter,
            .run = __test__test_move_file_corrupt_source_dest__run,
        },
        {
            .name = "test_move_file_after_corrupt",
            .path = "tests/test_move.toml:257",
            .flags = 0,
            .permutations = 1,
            .filter = __test__test_move_file_after_corrupt__filter,
            .run = __test__test_move_file_after_corrupt__run,
        },
        {
            .name = "test_move_reentrant_file",
            .path = "tests/test_move.toml:358",
            .flags = TEST_REENTRANT,
            .permutations = 1,
            .run = __test__test_move_reentrant_file__run,
        },
        {
            .name = "test_move_dir",
            .path = "tests/test_move.toml:475",
            .flags = 0,
            .permutations = 1,
            .run = __test__test_move_dir__run,
        },
        {
            .name = "test_move_dir_corrupt_source",
            .path = "tests/test_move.toml:543",
            .flags = 0,
            .permutations = 1,
            .run = __test__test_move_dir_corrupt_source__run,
        },
        {
            .name = "test_move_dir_corrupt_source_dest",
            .path = "tests/test_move.toml:629",
            .flags = 0,
            .permutations = 1,
            .filter = __test__test_move_dir_corrupt_source_dest__filter,
            .run = __test__test_move_dir_corrupt_source_dest__run,
        },
        {
            .name = "test_move_dir_after_corrupt",
            .path = "tests/test_move.toml:732",
            .flags = 0,
            .permutations = 1,
            .filter = __test__test_move_dir_after_corrupt__filter,
            .run = __test__test_move_dir_after_corrupt__run,
        },
        {
            .name = "test_reentrant_dir",
            .path = "tests/test_move.toml:840",
            .flags = TEST_REENTRANT,
            .permutations = 1,
            .run = __test__test_reentrant_dir__run,
        },
        {
            .name = "test_move_state_stealing",
            .path = "tests/test_move.toml:961",
            .flags = 0,
            .permutations = 1,
            .run = __test__test_move_state_stealing__run,
        },
        {
            .name = "test_move_create_delete_same",
            .path = "tests/test_move.toml:1031",
            .flags = 0,
            .permutations = 1,
            .run = __test__test_move_create_delete_same__run,
        },
        {
            .name = "test_move_create_delete_delete_same",
            .path = "tests/test_move.toml:1182",
            .flags = 0,
            .permutations = 1,
            .run = __test__test_move_create_delete_delete_same__run,
        },
        {
            .name = "test_move_create_delete_different",
            .path = "tests/test_move.toml:1344",
            .flags = 0,
            .permutations = 1,
            .run = __test__test_move_create_delete_different__run,
        },
        {
            .name = "test_move_fix_relocation",
            .path = "tests/test_move.toml:1587",
            .flags = 0,
            .permutations = 4,
            .defines = (const test_define_t*)__test__test_move_fix_relocation__defines,
            .run = __test__test_move_fix_relocation__run,
        },
        {
            .name = "test_move_fix_relocation_predecessor",
            .path = "tests/test_move.toml:1732",
            .flags = 0,
            .permutations = 8,
            .defines = (const test_define_t*)__test__test_move_fix_relocation_predecessor__defines,
            .run = __test__test_move_fix_relocation_predecessor__run,
        },
    },
    .case_count = 17,
};

